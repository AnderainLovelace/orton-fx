#include <stdlib.h> //for srand
#include <fxlib.h> //for Bdisp_PutDisp_DD, PrintMini and GetKey
#include "draw.h"
#include "game.h"
#include "level.h"
#include <setjmp.h>

jmp_buf exit_jmp;

int time();

void title()
{
	char title[]=
	{0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xE3,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xF8,0x3F,0xFF,0xE3,0xFF,0xFF,0xFF,0xFF,0xFF,0x3F,0xFF,0xFF,0xF7,0x7F,0xFF,
	0xFF,0xE0,0xF,0xFF,0xE1,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0xF1,0xFF,0xF7,0xFF,0xC7,
	0xFF,0xC0,0xF,0xF1,0x80,0x70,0xFF,0xFF,0xFF,0xFE,0x26,0x67,0x91,0x11,0x64,0x77,
	0xFF,0x83,0x86,0x0,0x80,0x60,0x7F,0xFF,0xFF,0xFF,0x5A,0xEC,0xB1,0x55,0x5C,0xEF,
	0xFF,0x87,0xC6,0x0,0xC0,0xC0,0x3F,0xFF,0xFF,0xFF,0x5A,0xEE,0xAD,0x55,0x5F,0x5F,
	0xFF,0xF,0xC2,0x8,0xE3,0x86,0x38,0xFF,0xFF,0xFF,0x66,0xF0,0xA1,0x15,0x64,0x47,
	0xFF,0xF,0xE3,0x1C,0xE3,0x8F,0x38,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0xFF,0xFF,
	0xFF,0x1F,0xE3,0x1F,0xE3,0x9F,0x30,0xF,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0xFF,0xFF,
	0xFF,0x1F,0xE3,0x1F,0xE3,0x9E,0x30,0x8F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xF,0xE3,0x1F,0xE3,0x8E,0x31,0x9F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0x8F,0xE3,0x9F,0xE3,0x84,0x63,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0x8F,0xC7,0x9F,0xE3,0xC0,0xE3,0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xC7,0xC7,0x9F,0xFF,0xE1,0xE6,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xC3,0x87,0xFF,0xFF,0xFF,0xE6,0x7F,0xFF,0xFF,0xFF,0xFF,0xFE,0x0,0x1,0xFF,
	0xFF,0xE0,0xF,0xFF,0xFF,0xFF,0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0x0,0x1,0xFF,
	0xFF,0xF0,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0x7F,0xF9,0xFF,
	0xFF,0xFC,0x7F,0xFF,0x9F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0x7F,0xF9,0xFF,
	0xFF,0xFF,0xFF,0xFF,0x8F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0x7F,0xF9,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xF,0xFF,0xFC,0xFF,0xFD,0xFF,0xFF,0xFF,0xFE,0x1E,0x79,0xFF,
	0xFF,0xFF,0xFF,0xFF,0x4F,0x2F,0xFC,0xFF,0xFD,0xFF,0xF,0xFF,0xFE,0x1E,0x79,0xFF,
	0xFF,0xFF,0xFF,0xFF,0x6F,0x7,0xFD,0xFF,0xFC,0xFE,0x27,0xFF,0xFE,0x7F,0xF9,0xFF,
	0xFF,0xFF,0xFF,0xFE,0x6F,0x17,0x1,0xFF,0x3C,0xCE,0x6F,0xFF,0xFE,0x7F,0xF9,0xFF,
	0xFF,0xFF,0xFF,0xFE,0x7,0x36,0x61,0xFF,0x1C,0x86,0xCF,0xFF,0xFE,0x7F,0xF9,0xFF,
	0xFF,0xFF,0xFF,0xFE,0x7,0x36,0xF3,0xFE,0xC,0x26,0x1F,0xFF,0xFE,0x7F,0xF9,0xFF,
	0xFF,0xFF,0xFF,0xFC,0x67,0x76,0xF3,0xFE,0xE,0x72,0x33,0xFF,0xFE,0x7F,0xF9,0xFF,
	0xFF,0xFF,0xFF,0xFC,0xF3,0x66,0xF3,0xFF,0x3E,0x73,0x7,0xFF,0xFE,0x7F,0xF9,0xFF,
	0xFF,0xFF,0xFF,0xFC,0xFF,0x66,0x63,0xFF,0x3E,0x73,0x9F,0xFF,0xFE,0x7F,0xF9,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x7,0xFF,0x3E,0x79,0xFF,0xFF,0xFE,0x0,0x1,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xE7,0xFF,0x3E,0x7F,0xFF,0xFF,0xFE,0x0,0x1,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x3E,0x7F,0xFF,0xFF,0xFF,0xE7,0x9F,0xFF,
	0xFF,0xFF,0xF8,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xE7,0x9F,0xFF,
	0xFF,0xFF,0xF0,0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC3,0xFF,0xE7,0xFF,0xFF,
	0xFF,0xFF,0xF0,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x81,0xFF,0xFF,0xF3,0xFF,
	0xFF,0xFF,0xF3,0xF,0xFF,0x9F,0xFF,0xFF,0xFF,0xFF,0xFF,0x9,0xFF,0xF9,0xF3,0xFF,
	0xFF,0xFF,0xE3,0x8F,0xFF,0xF,0xFF,0xFF,0xFF,0xFF,0x8E,0x3F,0xFF,0xF9,0xFF,0xFF,
	0xFF,0xFF,0xE3,0xCF,0xFF,0x9F,0xFF,0xFF,0xFF,0xFE,0x6,0x3F,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xE3,0xCF,0xFF,0xFF,0xFF,0xFF,0xFC,0x3C,0x7,0x0,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xC1,0xE,0x7F,0xFF,0xFF,0xFF,0xF0,0x1C,0xFF,0xF8,0x7F,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xC0,0x1E,0x3,0xFE,0x67,0xC1,0xE0,0x1C,0x7F,0xFC,0x7F,0xFF,0xFF,0xFF,
	0xFF,0xFF,0x80,0x3C,0x1,0x9C,0x43,0x80,0xE3,0x1E,0x7,0x90,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0x8F,0xFC,0x11,0x9C,0x3,0x8C,0xC6,0x3F,0xE3,0x80,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0x8F,0xFC,0x71,0x9C,0x33,0x1F,0xC0,0x7F,0xF3,0xC3,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xF,0xFC,0x7B,0x9C,0x33,0x1F,0xC1,0xFE,0xC3,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0x1F,0xF8,0xFF,0x1C,0x73,0x3F,0xC7,0xCE,0x3,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0x9F,0xF8,0xFF,0x1C,0x73,0x3F,0xC3,0xF,0xF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xF8,0xFF,0x1C,0x73,0xC,0x60,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xF8,0xFF,0x1C,0x73,0x80,0x70,0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0x1C,0x73,0xC1,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xDF,0xFF,0x7F,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0x7F,0xFF,0xFF,0x5F,0xFF,0x5F,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0xB7,0xFF,0xFF,0xDB,0xFF,0x7F,0xFF,0x77,0x7F,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0x6A,0x44,0x11,0x55,0xFC,0x51,0x82,0xA2,0xAB,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0xA6,0xD5,0x55,0x53,0xD,0x55,0xAA,0x76,0x67,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0xAE,0xD5,0x55,0x57,0xFD,0x55,0xAA,0xF6,0xEF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFE,0xA2,0x45,0x51,0x51,0xFC,0x50,0xAA,0x32,0x2F,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xF7,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF};
	int key=0, i;
	write_graph(0,0,128,64,title);
	while(key != KEY_CTRL_EXE) GetKey(&key);
}

void end(int n)
{
	char bmp[] = {255, 255, 255, 255, 255, 255, 255, 255, 254, 0, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 254, 0, 127, 255, 255, 255, 255, 255, 255, 255, 255, 255, 252, 239, 255, 255, 254, 0, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 192, 71, 255, 255, 254, 63, 255, 255, 207, 255, 255, 255, 255, 255, 255, 252, 0, 71, 255, 255, 254, 63, 255, 2555, 255, 227, 241, 152, 7, 254, 0, 156, 134, 63, 255, 255, 255, 255, 255, 255, 255, 227, 241, 156, 15, 255, 0, 156, 192, 63, 255, 255, 255, 255, 255, 255, 255, 227, 241, 255, 255, 255, 255, 255, 224, 127, 255, 255, 255, 255, 255, 255, 255, 243, 255, 255, 255, 255, 255, 255, 248, 127, 255, 255, 255, 255, 255, 255, 255, 243, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255};
	int key=0;
	write_graph(0,0,128,64,bmp);
	switch(n)
	{
		case 1:
			//memcpy(vram_adress()+160, bmp, 288);
			PrintMini(12, 42, "Doh ! Looks like you missed", MINI_REV);
			PrintMini(24, 49, "the secret ending...", MINI_REV);
			PrintMini(1, 57, "Press EXE if you want to find it.", MINI_REV);
			break;
		case 2:
			//memcpy(vram_adress()+256, bmp, 288);
			PrintMini(16, 42, "...and they lived happily", MINI_REV);
			PrintMini(44, 49, "ever after.", MINI_REV);
			PrintMini(38, 57, "Well, almost.", MINI_REV);
			break;
	}
	Bdisp_PutDisp_DD();
	IsKeyDown(KEY_CTRL_EXE);
	while(key != KEY_CTRL_EXE) GetKey(&key);
}

int AddIn_main(int isAppli, unsigned short OptionNum)
{
	int id_level=0;
	Level* level;

	if (setjmp(exit_jmp))
	{
		return 0;
	}

	title();
	srand(time());
	draw_init();

	level = load_level(id_level);
	while(id_level < NB_LEVELS)
	{
		game(level);
		free_level(level);
		id_level++;
		level = load_level(id_level);
	}
	while(game(level))
	{
		end(1);
		free_level(level);
		level = load_level(id_level);
	}
	free_level(level);
	id_level++;
	level = load_level(id_level);
	while(level)
	{
		game(level);
		free_level(level);
		id_level++;
		level = load_level(id_level);
	}
	end(2);
	return 1;
}


#pragma section _BR_Size
unsigned long BR_Size;
#pragma section

#pragma section _TOP

int InitializeSystem(int isAppli, unsigned short OptionNum)
{
    return INIT_ADDIN_APPLICATION(isAppli, OptionNum);
}

#pragma section
